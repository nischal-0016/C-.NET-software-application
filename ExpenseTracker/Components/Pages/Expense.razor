@page "/expenses"
@using ExpenseTracker.Models
@using ExpenseTracker.Services
@inject TransactionService TransactionService
@inject TagService TagService
@inject NavigationManager NavigationManager

<h3>Add Transaction</h3>

<EditForm Model="@newTransaction" OnValidSubmit="@AddTransaction" class="transaction-form">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label>Date:</label>
        <InputDate @bind-Value="newTransaction.Date" class="form-control" />
    </div>

    <div class="form-group">
        <label>Title:</label>
        <InputText @bind-Value="newTransaction.Title" class="form-control" />
        <ValidationMessage For="@(() => newTransaction.Title)" />
    </div>

    <div class="form-group">
        <label>Amount:</label>
        <InputNumber @bind-Value="newTransaction.Amount" class="form-control" />
        <ValidationMessage For="@(() => newTransaction.Amount)" />
    </div>

    <div class="form-group">
        <label>Transaction Type:</label>
        <InputSelect @bind-Value="newTransaction.Type" class="form-control" @onchange="HandleTypeChange">
            <option value="">Select Type</option>
            <option value="Inflow">Inflow</option>
            <option value="Outflow">Outflow</option>
            <option value="Debt">Debt</option>
        </InputSelect>
        <ValidationMessage For="@(() => newTransaction.Type)" />
    </div>

    @if (newTransaction.Type == "Inflow" && HasPendingDebts)
    {
        <div class="form-group">
            <label>Apply to Debt:</label>
            <InputSelect @bind-Value="selectedDebtId" class="form-control">
                <option value="">Don't apply to debt</option>
                @foreach (var debt in PendingDebts)
                {
                    <option value="@debt.Id">@debt.Title - Rs @debt.Amount.ToString("N2")</option>
                }
            </InputSelect>
        </div>
    }

    <div class="form-group">
        <label>Tag (Optional):</label>
        <InputSelect @bind-Value="selectedTag" class="form-control">
            <option value="">Select Tag</option>
            @foreach (var tag in TagService.Tags)
            {
                <option value="@tag">@tag</option>
            }
        </InputSelect>
    </div>

    <div class="form-group">
        <label>Notes:</label>
        <InputTextArea @bind-Value="newTransaction.Notes" class="form-control" />
    </div>

    <div class="button-group">
        <button type="submit" class="btn btn-primary">Add Transaction</button>
        <button type="button" class="btn btn-secondary" @onclick="NavigateToDashboard">Cancel</button>
    </div>
</EditForm>
@code {
    private TransactionItem newTransaction = new() { Date = DateTime.Today };
    private string selectedTag;
    private string selectedDebtId;
    private bool HasPendingDebts => PendingDebts.Any();

    private List<TransactionItem> PendingDebts => TransactionService.Transactions
        .Where(t => t.Type == "Debt" && !t.IsPaid)
        .ToList();

    private void HandleTypeChange(ChangeEventArgs e)
    {
        selectedDebtId = string.Empty;
    }

    private void AddTransaction()
    {
        if (!string.IsNullOrWhiteSpace(selectedTag))
        {
            newTransaction.Tag = selectedTag;
        }

        if (newTransaction.Type == "Inflow" && !string.IsNullOrEmpty(selectedDebtId))
        {
            var debt = TransactionService.Transactions
                .FirstOrDefault(t => t.Id == selectedDebtId);

            if (debt != null)
            {
                HandleDebtPayment(debt);
            }
            else
            {
                TransactionService.AddTransaction(newTransaction);
            }
        }
        else if (newTransaction.Type == "Outflow")
        {
            HandleOutflowTransaction();
        }
        else
        {
            TransactionService.AddTransaction(newTransaction);
        }

        NavigateToDashboard();
    }

    private void HandleOutflowTransaction()
    {
        var totalInflow = TransactionService.Transactions
            .Where(t => t.Type == "Inflow")
            .Sum(t => t.Amount);

        var totalOutflow = TransactionService.Transactions
            .Where(t => t.Type == "Outflow")
            .Sum(t => t.Amount);

        var availableBalance = totalInflow - totalOutflow;

        TransactionService.AddTransaction(new TransactionItem
            {
                Date = newTransaction.Date,
                Title = newTransaction.Title,
                Amount = newTransaction.Amount,
                Type = "Outflow",
                Notes = newTransaction.Notes,
                Tag = newTransaction.Tag
            });

        if (newTransaction.Amount > availableBalance)
        {
            var deficit = newTransaction.Amount - availableBalance;

            var debtTransaction = new TransactionItem
                {
                    Date = newTransaction.Date,
                    Title = $"Debt for {newTransaction.Title}",
                    Amount = deficit,
                    Type = "Debt",
                    Notes = "Debt",
                    Tag = newTransaction.Tag,
                    IsPaid = false
                };
            TransactionService.AddTransaction(debtTransaction);
        }
    }


    private void HandleDebtPayment(TransactionItem debt)
    {
        var debtPayment = new TransactionItem
            {
                Date = newTransaction.Date,
                Title = $"Debt Payment - {debt.Title}",
                Amount = Math.Min(newTransaction.Amount, debt.Amount),
                Type = "DebtPayment",
                Notes = $"Payment for debt: {debt.Title}",
                RelatedTransactionId = debt.Id
            };

        debt.IsPaid = debtPayment.Amount >= debt.Amount;
        if (!debt.IsPaid)
        {
            debt.Amount -= debtPayment.Amount;
        }

        newTransaction.Amount -= debtPayment.Amount;

        TransactionService.AddTransaction(debtPayment);
        if (newTransaction.Amount > 0)
        {
            TransactionService.AddTransaction(newTransaction);
        }
    }

    private void NavigateToDashboard()
    {
        NavigationManager.NavigateTo("/dashboard");
    }
}
